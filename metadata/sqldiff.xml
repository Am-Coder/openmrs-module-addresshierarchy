<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqldiff PUBLIC "-//OpenMRS//DTD OpenMRS SQL Diff Config 1.0//EN" "http://resources.openmrs.org/doctype/sqldiff-1.0.dtd">

<sqldiff version="1.0">
	<help>
		USE:
			The diffs are ordered by datamodel version number.
			The script can be run in a top down fashion and is
			expected to not fail or overwrite old data
		
		EXPECT:
			- "use business-database-name;" was called prior to
			   calling this script
	</help>
	
		<diff>
		<version>1.0</version>
		<author>Sri Prasanna</author>
		<date>May 28th 2008</date>
		<description>
			Address hierarchy type table. It stores the hierarchy components and its type ID.
			Address hierarchy table. It stores the hierarchy component values.
		</description>
		<sql>
			CREATE TABLE IF NOT EXISTS address_hierarchy_type
            (
            	location_attribute_type_id int(11) NOT NULL auto_increment,
                name varchar(160) NOT NULL,
                PRIMARY KEY (location_attribute_type_id)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
            
			CREATE TABLE IF NOT EXISTS address_hierarchy
            (
            	location_attribute_type_value_id int(11) NOT NULL auto_increment,
                name varchar(160) NOT NULL,
                type_id int(11) NOT NULL,
                parent_location_attribute_type_value_id int(11),
                PRIMARY KEY (`location_attribute_type_value_id`),
                KEY `parent_location_id` (`parent_location_attribute_type_value_id`),
                KEY `location_type_id` (`type_id`),
                CONSTRAINT `parent_location_id` FOREIGN KEY (`parent_location_attribute_type_value_id`) REFERENCES `address_hierarchy` (`location_attribute_type_value_id`),
                CONSTRAINT `location_type_id` FOREIGN KEY (`type_id`) REFERENCES `address_hierarchy_type` (`location_attribute_type_id`)
			) ENGINE=InnoDB DEFAULT CHARSET=utf8;
			
		</sql>
	</diff>
	
	<diff>
		<version>1.1</version>
		<author>Mark Goodrich</author>
		<date>April 21th 2011</date>
		<description>
			This updates the tables to the Rwanda Address Hierarchy format
		</description>
		
		<sql>
			ALTER TABLE address_hierarchy ADD COLUMN user_generated_id varchar(11);
			ALTER TABLE address_hierarchy DROP FOREIGN KEY location_type_id;
			ALTER TABLE address_hierarchy DROP KEY location_type_id;
			ALTER TABLE address_hierarchy DROP FOREIGN KEY parent_location_id;
			ALTER TABLE address_hierarchy DROP KEY parent_location_id;
			
			ALTER TABLE address_hierarchy CHANGE COLUMN location_attribute_type_value_id `address_hierarchy_id` int(11) NOT NULL auto_increment;
			ALTER TABLE address_hierarchy CHANGE COLUMN parent_location_attribute_type_value_id `parent_id` int(11);
		
			ALTER TABLE address_hierarchy ADD KEY `parent_location_id` (`parent_id`);
			ALTER TABLE address_hierarchy ADD CONSTRAINT `parent_location_id` FOREIGN KEY (`parent_id`) REFERENCES `address_hierarchy` (`address_hierarchy_id`);
            ALTER TABLE address_hierarchy ADD KEY `location_type_id` (`type_id`);
            ALTER TABLE address_hierarchy ADD CONSTRAINT `location_type_id` FOREIGN KEY (`type_id`) REFERENCES `address_hierarchy_type` (`location_attribute_type_id`);
			
            ALTER TABLE address_hierarchy_type ADD COLUMN `parent_type_id` int(11) default NULL;
            ALTER TABLE address_hierarchy_type ADD COLUMN `child_type_id` int(11) default NULL;
		</sql>
		
	</diff>
	
	
	<!-- now execute the other diffs added by the Rwanda Address Hierarchy module -->
	<diff>
		<version>1.3</version>
		<author>John DeRiggi</author>
		<date>November 6 2009</date>
		<description>
			Add spatial information to the address hierarchy regions.
		</description>
		<sql>
			DROP TABLE IF EXISTS unstructured_address;
			ALTER TABLE address_hierarchy add column latitude double, add column longitude double, add column elevation double;
			
		</sql>
	</diff>	
	
	<diff>
		<version>1.3.2</version>
		<author>John DeRiggi</author>
		<date>Nov 14 2010</date>
		<description>
			Added index on person address created date and fixed possible bug with white space on provinces
		</description>
		<sql>
			create index name_ah on address_hierarchy(name);
			create index person_address_date_created_index on person_address(date_created);
			update person_address set person_address.state_province = trim(state_province);
		</sql>
	</diff>
	<!-- end of diffs added by the Rwanda Address Hierarchy module -->
	<!-- when updating from Rwanda Address Hierarchy module set global prop addresshierarchy.database_version = 1.3.2 -->
	
	<diff>
		<version>1.4</version>
		<author>Mark Goodrich</author>
		<date>Apr 21 2011</date>
		<description>
			Change name of id on address hierarchy type (need to drop foreign key constraint)
			Note that we should add this foreign key constraint back in, but for some reason I can't get it to work
		</description>
		<sql>
			ALTER TABLE address_hierarchy DROP FOREIGN KEY location_type_id;
		    ALTER TABLE address_hierarchy_type CHANGE COLUMN `location_attribute_type_id` `address_hierarchy_type_id` int(11) NOT NULL AUTO_INCREMENT;
		</sql>
	</diff>
	
	<diff>
		<version>1.5</version>
		<author>Mark Goodrich</author>
		<date>Apr 22 2011</date>
		<description>
			Add the new field that we are using to store what address field a type maps to
		</description>
		<sql>
			ALTER TABLE address_hierarchy_type ADD COLUMN `address_field` varchar(50) NOT NULL;
		</sql>
	</diff>
	
	<diff>
		<version>1.6</version>
		<author>Mark Goodrich</author>
		<date>Apr 22 2011</date>
		<description>
			Added OpenmrsMetadata fields to Address Hierarchy table
		</description>
		<sql>
			ALTER TABLE address_hierarchy
			ADD COLUMN `description`
			varchar(1000),
			ADD COLUMN `creator` int(11) NOT NULL default '0',
			ADD
			COLUMN `date_created` datetime NOT NULL default '0000-00-00
			00:00:00',
			ADD COLUMN `changed_by` int(11) default NULL,
			ADD COLUMN
			`date_changed` datetime default NULL,
			ADD COLUMN `retired` tinyint(1)
			NOT NULL default '0',
			ADD COLUMN `retired_by` int(11) default NULL,
			ADD COLUMN `date_retired` datetime default NULL,
			ADD COLUMN
			`retire_reason` varchar(255) default NULL,
			ADD COLUMN `uuid` char(38)
			NOT NULL;
		</sql>
	</diff>
	
	<diff>
		<version>1.7</version>
		<author>Mark Goodrich</author>
		<date>Apr 22 2011</date>
		<description>
			Added OpenmrsMetadata fields to Address Hierarchy type table
		</description>
		<sql>
			ALTER TABLE address_hierarchy_type
			ADD COLUMN `description`
			varchar(1000),
			ADD COLUMN `creator` int(11) NOT NULL default '0',
			ADD
			COLUMN `date_created` datetime NOT NULL default '0000-00-00
			00:00:00',
			ADD COLUMN `changed_by` int(11) default NULL,
			ADD COLUMN
			`date_changed` datetime default NULL,
			ADD COLUMN `retired` tinyint(1)
			NOT NULL default '0',
			ADD COLUMN `retired_by` int(11) default NULL,
			ADD COLUMN `date_retired` datetime default NULL,
			ADD COLUMN
			`retire_reason` varchar(255) default NULL,
			ADD COLUMN `uuid` char(38)
			NOT NULL;
		</sql>
	</diff>
	
	<diff>
		<version>1.8</version>
		<author>Mark Goodrich</author>
		<date>Apr 25 2011</date>
		<description>
			Remove child_type_id from address_hierarchy_type table
		</description>
		<sql>
			ALTER TABLE address_hierarchy_type DROP COLUMN child_type_id;
		</sql>
	</diff>
	
	<diff>
		<version>1.9</version>
		<author>Mark Goodrich</author>
		<date>Apr 25 2011</date>
		<description>
			Rename address_hiearchy table
		</description>
		<sql>
			ALTER TABLE address_hierarchy RENAME address_hierarchy_entry;
		</sql>
	</diff>
	
	<diff>
		<version>2.0</version>
		<author>Mark Goodrich</author>
		<date>Apr 25 2011</date>
		<description>
			Change name of id on address hierarchy type to be consistent with new table name
			Note that we should add this foreign key constraint back in, but for some reason I can't get it to work:
			ALTER TABLE address_hierarchy_entry ADD CONSTRAINT `parent_location_id` FOREIGN KEY (`address_hierarchy_entry_id`) REFERENCES `address_hierarchy_entry` (`address_hierarchy_entry_id`);
		</description>
		<sql>
			ALTER TABLE address_hierarchy_entry DROP FOREIGN KEY parent_location_id;
		    ALTER TABLE address_hierarchy_entry CHANGE COLUMN `address_hierarchy_id` `address_hierarchy_entry_id` int(11) NOT NULL AUTO_INCREMENT;
		</sql>
	</diff>
	
	<diff>
		<version>2.1</version>
		<author>Mark Goodrich</author>
		<date>Apr 29 2011</date>
		<description>
			Rename address_hiearchy_type table
		</description>
		<sql>
			ALTER TABLE address_hierarchy_type RENAME address_hierarchy_level;
		</sql>
	</diff>
	
	<diff>
		<version>2.2</version>
		<author>Mark Goodrich</author>
		<date>Apr 29 2011</date>
		<description>
			Change the name of the address_hierarchy_type_id and parent_type_id to be consistent
		</description>
		<sql>
		    ALTER TABLE address_hierarchy_level CHANGE COLUMN `address_hierarchy_type_id` `address_hierarchy_level_id` int(11) NOT NULL AUTO_INCREMENT;
		    ALTER TABLE address_hierarchy_level CHANGE COLUMN `parent_type_id` `parent_level_id` int(11);
		</sql>
	</diff>
	
	<diff>
		<version>2.2.1</version>
		<author>Mark Goodrich</author>
		<date>Apr 29 2011</date>
		<description>
			Change the name of the type_id to level_id to be consistent
		</description>
		<sql>
		    ALTER TABLE address_hierarchy_entry CHANGE COLUMN `type_id` `level_id` int(11);
		</sql>
	</diff>
	
	<diff>
		<version>2.3</version>
		<author>Mark Goodrich</author>
		<date>May 2 2011</date>
		<description>
			Modify Address Hierarchy Level so name can be null
		</description>
		<sql>
			ALTER TABLE address_hierarchy_level CHANGE COLUMN `name` `name` varchar(160);
		</sql>
	</diff>
	
</sqldiff>
